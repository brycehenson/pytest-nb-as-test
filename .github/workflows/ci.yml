name: ci

on:
  push:
    branches: [ "main" ]
  pull_request: # This covers all PRs targeting any branch
  workflow_call:

permissions:
  contents: read

# This part stops the "double running" by canceling previous runs 
# on the same branch/PR if you push again quickly.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Compatibility matrix over supported Python and pytest versions.
  pytest:
    name: Tests (Python ${{ matrix.python-version }}, pytest ${{ matrix.pytest-label }})
    runs-on: ubuntu-latest
    timeout-minutes: 2
    continue-on-error: ${{ matrix.experimental || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.10"
            pytest-spec: "pytest==7.0.0"
            pytest-label: "7.0.0 (min)"
          - python-version: "3.10"
            pytest-spec: "pytest<9.1.0"
            pytest-label: "latest <9.1.0"
          - python-version: "3.11"
            pytest-spec: "pytest==7.0.0"
            pytest-label: "7.0.0 (min)"
          - python-version: "3.11"
            pytest-spec: "pytest<9.1.0"
            pytest-label: "latest <9.1.0"
          - python-version: "3.12"
            pytest-spec: "pytest==7.0.0"
            pytest-label: "7.0.0 (min)"
          - python-version: "3.12"
            pytest-spec: "pytest<9.1.0"
            pytest-label: "latest <9.1.0"
          - python-version: "3.13"
            pytest-spec: "pytest<9.1.0"
            pytest-label: "latest <9.1.0"
          - python-version: "3.14"
            pytest-spec: "pytest<9.1.0"
            pytest-label: "latest <9.1.0"
            experimental: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen  --group dev

      - name: Select pytest version for this matrix entry
        run: uv pip install --upgrade "${{ matrix.pytest-spec }}"

      - name: Run pytest
        run: |
          uv run --no-sync pytest --version
          uv run --no-sync pytest

  # Windows coverage for platform-specific behavior.
  pytest-windows:
    name: Tests (Windows, Python 3.12)
    runs-on: windows-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          allow-prereleases: true

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen --group dev

      - name: Run pytest
        run: |
          uv run pytest --version
          uv run pytest

  # Coverage report from one canonical runtime.
  pytest-coverage:
    name: Coverage (Python 3.12, latest pytest)
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen  --group dev

      - name: Run pytest with coverage
        run: >
          uv run pytest
          --cov=pytest_nb_as_test
          --cov-report=term-missing
          --cov-report=xml:coverage.xml
          --cov-report=lcov:lcov.info

      - name: Add coverage summary
        if: always()
        run: |
          python3 - <<'PY'
          import pathlib
          import xml.etree.ElementTree as et

          summary_path = pathlib.Path(".coverage-summary.md")
          xml_path = pathlib.Path("coverage.xml")
          if not xml_path.exists():
              summary_path.write_text("Coverage XML was not generated.\n")
          else:
              root = et.parse(xml_path).getroot()
              line_rate = float(root.attrib.get("line-rate", 0.0))
              summary_path.write_text(
                  "## Coverage Report\n\n"
                  f"- Line coverage: {line_rate * 100:.2f}%\n"
                  "- Reports: `coverage.xml`, `lcov.info`\n"
              )
          PY
          cat .coverage-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          if-no-files-found: ignore
          path: |
            coverage.xml
            lcov.info

  # Ensure the package still works when pytest-xdist is not installed.
  pytest-no-xdist:
    name: Tests (no xdist smoke)
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install runtime dependencies only
        run: uv sync --frozen

      - name: Verify pytest-xdist is not installed
        run: |
          uv run python -c "import importlib.util,sys;sys.exit(0 if importlib.util.find_spec('xdist') is None else 1)"

      - name: Run smoke pytest without repository config
        run: uv run pytest -c /dev/null tests/test_plugin.py -k test_run_simple_notebook


  # Static analysis for code quality checks.
  pylint:
    name: Lint (pylint)
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen  --group dev

      - name: Run pylint
        run: uv run pylint pytest_nb_as_test tests

  # Type-checking validation.
  pyright:
    name: Type Check (pyright)
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen  --group dev

      - name: Run pyright
        run: uv run pyright

  # Formatting checks for Python files and notebooks.
  format:
    name: Formatting Checks
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --frozen  --group dev

      - name: Check formatting
        run: |
          uv run black --version
          uv run black --check .

      - name: isort
        run: uv run isort --check-only .

      - name: nbqa isort
        run: uv run nbqa isort --check-only tests/


  # Pull request gate: require CHANGELOG updates.
  changelog:
    name: Changelog Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure CHANGELOG updated
        run: |
          set -euo pipefail
          base_ref="${{ github.base_ref }}"
          git fetch origin "${base_ref}":"refs/remotes/origin/${base_ref}" --depth=1
          if git diff --quiet "origin/${base_ref}" -- CHANGELOG.md; then
            echo "CHANGELOG.md has no changes relative to ${base_ref}."
            exit 1
          fi
